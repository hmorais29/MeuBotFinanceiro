<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado das APIs - Trading Bot</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            font-weight: bold;
            border-radius: 10px 10px 0 0 !important;
        }
        
        .api-card {
            transition: transform 0.2s;
        }
        
        .api-card:hover {
            transform: translateY(-2px);
        }
        
        .status-active { border-left: 4px solid var(--success-color); }
        .status-warning { border-left: 4px solid var(--warning-color); }
        .status-inactive { border-left: 4px solid var(--danger-color); }
        
        .progress {
            height: 8px;
        }
        
        .api-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Cabeçalho -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-network-wired me-2"></i>
                        Estado das APIs de Dados de Mercado
                        <span class="float-end" id="lastUpdate">Última atualização: --:--:--</span>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            O sistema usa fallback automático: <strong>Finnhub → Twelve Data → Alpha Vantage → yfinance</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Cards das APIs -->
        <div class="row" id="apiCards">
            <!-- Será preenchido via JavaScript -->
        </div>
        
        <!-- Logs recentes -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-list me-2"></i>
                        Logs de API (últimos 20)
                        <button class="btn btn-sm btn-outline-light float-end" onclick="clearLogs()">
                            <i class="fas fa-trash me-1"></i>Limpar
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="apiLogs" style="max-height: 300px; overflow-y: auto;">
                            <!-- Será preenchido via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Botão de refresh -->
    <button class="btn btn-primary btn-lg refresh-btn" onclick="refreshAPIStatus()">
        <i class="fas fa-sync-alt" id="refreshIcon"></i>
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Carrega dados iniciais
        document.addEventListener('DOMContentLoaded', function() {
            refreshAPIStatus();
            loadAPILogs();
            
            // Auto-refresh a cada 30 segundos
            setInterval(refreshAPIStatus, 30000);
        });

        function refreshAPIStatus() {
            const refreshIcon = document.getElementById('refreshIcon');
            refreshIcon.classList.add('fa-spin');
            
            // Simula chamada para /api/status
            setTimeout(() => {
                loadAPIStatus();
                refreshIcon.classList.remove('fa-spin');
                document.getElementById('lastUpdate').textContent = 
                    'Última atualização: ' + new Date().toLocaleTimeString();
            }, 1000);
        }

        function loadAPIStatus() {
            // Simula dados reais - em produção seria uma chamada AJAX
            const mockData = {
                finnhub: {
                    has_key: true,
                    remaining_calls: 45,
                    limit: 60,
                    status: 'active',
                    response_time: '120ms'
                },
                twelve_data: {
                    has_key: true,
                    remaining_calls: 6,
                    limit: 8,
                    status: 'warning',
                    response_time: '95ms'
                },
                alpha_vantage: {
                    has_key: true,
                    remaining_calls: 5,
                    limit: 5,
                    status: 'active',
                    response_time: '200ms'
                },
                yfinance: {
                    has_key: false, // Não precisa de chave
                    remaining_calls: 1800,
                    limit: 2000,
                    status: 'warning',
                    response_time: 'timeout'
                },
                newsapi: {
                    has_key: true,
                    remaining_calls: 85,
                    limit: 100,
                    status: 'active',
                    response_time: '150ms'
                }
            };
            
            renderAPICards(mockData);
        }

        function renderAPICards(apiData) {
            const container = document.getElementById('apiCards');
            const apis = [
                { key: 'finnhub', name: 'Finnhub', icon: 'fas fa-chart-line', primary: true },
                { key: 'twelve_data', name: 'Twelve Data', icon: 'fas fa-database', primary: true },
                { key: 'alpha_vantage', name: 'Alpha Vantage', icon: 'fas fa-chart-bar', primary: true },
                { key: 'yfinance', name: 'yfinance', icon: 'fab fa-yahoo', primary: true },
                { key: 'newsapi', name: 'News API', icon: 'fas fa-newspaper', primary: false }
            ];
            
            container.innerHTML = apis.map(api => {
                const data = apiData[api.key];
                const statusClass = getStatusClass(data);
                const percentage = (data.remaining_calls / data.limit) * 100;
                const progressClass = getProgressClass(percentage);
                
                return `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card api-card ${statusClass}">
                            <div class="card-body text-center">
                                <div class="api-icon text-${getIconColor(data.status)}">
                                    <i class="${api.icon}"></i>
                                </div>
                                <h5 class="card-title">${api.name}</h5>
                                ${api.primary ? '<span class="badge bg-primary mb-2">Dados de Mercado</span>' : '<span class="badge bg-secondary mb-2">Notícias</span>'}
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Calls Restantes</span>
                                        <span><strong>${data.remaining_calls}/${data.limit}</strong></span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar ${progressClass}" 
                                             style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-6">
                                        <small class="text-muted">Estado</small>
                                        <div class="fw-bold">${getStatusText(data.status)}</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">API Key</small>
                                        <div class="fw-bold">${data.has_key ? '✓ Configurada' : '✗ Em falta'}</div>
                                    </div>
                                </div>
                                
                                <div class="row mt-2">
                                    <div class="col-12">
                                        <small class="text-muted">Tempo de Resposta</small>
                                        <div class="fw-bold">${data.response_time}</div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="testAPI('${api.key}')">
                                        <i class="fas fa-vial me-1"></i>Testar
                                    </button>
                                    ${data.has_key ? '' : `<button class="btn btn-sm btn-warning" onclick="configureAPI('${api.key}')">
                                        <i class="fas fa-key me-1"></i>Configurar
                                    </button>`}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusClass(data) {
            if (!data.has_key || data.status === 'inactive') return 'status-inactive';
            if (data.remaining_calls < data.limit * 0.2) return 'status-warning';
            return 'status-active';
        }

        function getProgressClass(percentage) {
            if (percentage > 50) return 'bg-success';
            if (percentage > 20) return 'bg-warning';
            return 'bg-danger';
        }

        function getIconColor(status) {
            switch(status) {
                case 'active': return 'success';
                case 'warning': return 'warning';
                default: return 'danger';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'active': return 'Ativa';
                case 'warning': return 'Limitada';
                default: return 'Inativa';
            }
        }

        function testAPI(apiName) {
            alert(`A testar conexão com ${apiName}...`);
            // Em produção: fetch(`/api/test-connection/${apiName}`)
        }

        function configureAPI(apiName) {
            window.location.href = '/settings#api-keys';
        }

        function loadAPILogs() {
            // Simula logs - em produção seria fetch('/api/logs')
            const mockLogs = [
                { time: '14:32:15', level: 'INFO', message: 'Dados obtidos com sucesso via Finnhub para AAPL (50 velas)' },
                { time: '14:32:12', level: 'WARNING', message: 'API yfinance retornou timeout para ^GSPC' },
                { time: '14:32:10', level: 'DEBUG', message: 'Tentando obter dados via Finnhub para ^GSPC' },
                { time: '14:32:08', level: 'ERROR', message: 'API yfinance falhou para ^GSPC: Read timeout' },
                { time: '14:32:05', level: 'INFO', message: 'Dados obtidos com sucesso via Twelve Data para BTC-USD (100 velas)' },
                { time: '14:31:58', level: 'DEBUG', message: 'Rate limit check: Finnhub - 45/60 calls restantes' },
                { time: '14:31:55', level: 'INFO', message: 'Fallback automático ativado: yfinance → Finnhub' },
                { time: '14:31:52', level: 'WARNING', message: 'Twelve Data próximo do limite: 6/8 calls restantes' }
            ];
            
            const container = document.getElementById('apiLogs');
            container.innerHTML = mockLogs.map(log => `
                <div class="d-flex justify-content-between border-bottom py-2">
                    <span>
                        <span class="badge bg-${getLogBadgeClass(log.level)} me-2">${log.level}</span>
                        ${log.message}
                    </span>
                    <small class="text-muted">${log.time}</small>
                </div>
            `).join('');
        }

        function getLogBadgeClass(level) {
            switch(level) {
                case 'ERROR': return 'danger';
                case 'WARNING': return 'warning';
                case 'INFO': return 'info';
                case 'DEBUG': return 'secondary';
                default: return 'light';
            }
        }

        function clearLogs() {
            if (confirm('Limpar todos os logs?')) {
                document.getElementById('apiLogs').innerHTML = '<p class="text-muted text-center">Logs limpos</p>';
            }
        }
    </script>
</body>
</html>